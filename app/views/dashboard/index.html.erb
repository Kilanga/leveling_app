

<h1>Bienvenue, <%= current_user.pseudo %> !</h1>

<h2></h2>

<div class="d-flex justify-content-center position-relative">
  <canvas id="statsChart" width="400" height="400"
          data-stats='<%= @stats_data.to_json.html_safe %>'></canvas>
  <div id="totalLevelDisplay" class="position-absolute fw-bold fs-4"
       style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
  </div>
</div>

<h2 class="mt-4">Progression des catÃ©gories</h2>

<% @stats.each do |stat| %>
  <% # Utiliser le mÃªme calcul que pour le chart %>
  <% level = 1 %>
  <% xp_remaining = stat.total_xp %>
  <% xp_needed_for_next = xp_needed_for_next_level(level) %>

  <% while xp_remaining >= xp_needed_for_next %>
    <% xp_remaining -= xp_needed_for_next %>
    <% level += 1 %>
    <% xp_needed_for_next = xp_needed_for_next_level(level) %>
  <% end %>

  <% xp_needed = xp_needed_for_next %>

  <div class="progress-container mb-3">
    <div class="progress-label">
      <strong><%= stat.category.name %> (Niveau <%= level %>)</strong>
      <span class="xp-info"><%= xp_remaining %> / <%= xp_needed %> XP</span>
    </div>
    <div class="progress" style="height: 20px; background-color: #333;">
      <div class="progress-bar" role="progressbar"
           style="width: <%= (xp_remaining.to_f / xp_needed * 100).round %>%;
                  background: linear-gradient(90deg, #ffcc00, #ff6600);"
           aria-valuenow="<%= xp_remaining %>" aria-valuemin="0" aria-valuemax="<%= xp_needed %>">
      </div>
    </div>
  </div>
<% end %>


<h2>ğŸ”¹ QuÃªtes Hebdomadaires</h2>

<% if @weekly_quests.any? %>
  <ul class="list-group">
    <% @weekly_quests.each do |user_weekly_quest| %>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong><%= user_weekly_quest.weekly_quest.title %></strong>
          <p><%= user_weekly_quest.weekly_quest.description %></p>
        </div>
        <% unless user_weekly_quest.completed? %>
          <%= button_to "âœ” Valider", user_weekly_quest_path(user_weekly_quest), method: :patch, params: { action_type: "complete" }, class: "btn btn-success btn-sm" %>
        <% else %>
          <span class="badge bg-success">âœ… ComplÃ©tÃ©e</span>
        <% end %>
      </li>
    <% end %>
  </ul>
<% else %>
  <div class="alert alert-info text-center">
    ğŸŒŸ Les quÃªtes hebdomadaires arrivent bientÃ´t ! Reviens plus tard pour relever de nouveaux dÃ©fis. ğŸš€
  </div>
<% end %>

<h2>QuÃªtes en cours</h2>
<ul class="list-group">
  <% current_user.user_quests.includes(:quest).where(completed: false, active: true).each do |user_quest| %>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <strong><%= user_quest.quest.title %></strong>
        <p class="text-muted"><%= user_quest.quest.category.name %> - <%= user_quest.quest.xp %> XP</p>
        <p class="text-muted">ComplÃ©tÃ©e <%= user_quest.completed_count %> fois</p>
      </div>
      <div>
        <%= form_with url: user_quest_path(user_quest), method: :patch, class: "d-inline" do %>
          <%= hidden_field_tag :action_type, "complete" %>
          <%= submit_tag "âœ” Valider", class: "btn btn-success btn-sm" %>
        <% end %>

        <%= form_with url: user_quest_path(user_quest), method: :patch, class: "d-inline" do %>
          <%= hidden_field_tag :action_type, "unfollow" %>
          <%= submit_tag "âœ– ArrÃªter", class: "btn btn-danger btn-sm" %>
        <% end %>
      </div>
    </li>
  <% end %>
</ul>
<%= link_to "Voir toutes les quÃªtes", quests_path, class: "btn btn-primary" %>
<%= link_to "Boutique", new_purchase_path, class: "btn btn-warning" %>
